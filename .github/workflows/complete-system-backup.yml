name: Complete System Backup

on:
  push:
    branches: [ main ]
  schedule:
    # Backup completo semanal - Domingos 02:00 UTC
    - cron: '0 2 * * 0'
  workflow_dispatch:

permissions:
  contents: write
  actions: write

jobs:
  backup-system:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Setup environment
      run: |
        echo "BACKUP_TIMESTAMP=$(date -u +'%Y-%m-%dT%H-%M-%S')" >> $GITHUB_ENV
        echo "BACKUP_DIR=./backups" >> $GITHUB_ENV
        echo "COMMIT_HASH=$(git rev-parse HEAD)" >> $GITHUB_ENV
        echo "COMMIT_MESSAGE=$(git log -1 --pretty=format:'%s')" >> $GITHUB_ENV

    - name: Create backup directory
      env:
        BACKUP_DIR: ./backups
      run: mkdir -p ${{ env.BACKUP_DIR }}

    - name: Backup Source Code
      env:
        BACKUP_DIR: ./backups
        BACKUP_TIMESTAMP: ${{ env.BACKUP_TIMESTAMP }}
      run: |
        echo "üì¶ Backup do c√≥digo fonte..."
        tar -czf "${{ env.BACKUP_DIR }}/source-code-${{ env.BACKUP_TIMESTAMP }}.tar.gz" \
          --exclude=node_modules \
          --exclude=.git \
          --exclude=backups \
          --exclude=dist \
          .
        
        SOURCE_SIZE=$(du -h "${{ env.BACKUP_DIR }}/source-code-${{ env.BACKUP_TIMESTAMP }}.tar.gz" | cut -f1)
        echo "SOURCE_SIZE=$SOURCE_SIZE" >> $GITHUB_ENV
        echo "‚úÖ C√≥digo backup: $SOURCE_SIZE"

    - name: Backup Database
      if: ${{ github.event.inputs.backup_type == 'full' || github.event.inputs.backup_type == 'database_only' || github.event.inputs.backup_type == '' }}
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        BACKUP_TIMESTAMP: ${{ env.BACKUP_TIMESTAMP }}
        BACKUP_DIR: ${{ env.BACKUP_DIR }}
      run: |
        echo "üóÑÔ∏è Backup do banco de dados..."
        
        # Backup usando script Node.js
        node scripts/backup-database-simple.cjs "${{ env.BACKUP_DIR }}/database-${{ env.BACKUP_TIMESTAMP }}.json"

    - name: Create backup manifest
      env:
        BACKUP_TIMESTAMP: ${{ env.BACKUP_TIMESTAMP }}
        BACKUP_DIR: ${{ env.BACKUP_DIR }}
        COMMIT_HASH: ${{ env.COMMIT_HASH }}
        COMMIT_MESSAGE: ${{ env.COMMIT_MESSAGE }}
        SOURCE_SIZE: ${{ env.SOURCE_SIZE }}
      run: |
        cat << 'EOF' > backup-manifest.json
        {
          "timestamp": "${{ env.BACKUP_TIMESTAMP }}",
          "commit": {
            "hash": "${{ env.COMMIT_HASH }}",
            "message": "${{ env.COMMIT_MESSAGE }}"
          },
          "files": {
            "source_code": {
              "path": "source-code-${{ env.BACKUP_TIMESTAMP }}.tar.gz",
              "size": "${{ env.SOURCE_SIZE }}"
            },
            "database": {
              "path": "database-${{ env.BACKUP_TIMESTAMP }}.json",
              "size": "Database backup"
            }
          }
        }
        EOF

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: complete-backup-${{ env.BACKUP_TIMESTAMP }}
        path: |
          ${{ env.BACKUP_DIR }}/*
          backup-manifest.json
        retention-days: 30

    - name: Success notification
      run: |
        echo "üéâ Backup completo realizado com sucesso!"
        echo "üì¶ C√≥digo fonte: ${{ env.SOURCE_SIZE }}"
        echo "üóÑÔ∏è Banco de dados: Backup conclu√≠do"
        echo "‚è∞ Timestamp: ${{ env.BACKUP_TIMESTAMP }}"
        echo "üîó Commit: ${{ env.COMMIT_HASH }}"
